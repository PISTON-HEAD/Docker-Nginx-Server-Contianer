name: IBE Integration POD Onboarding

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  check_approval:
    runs-on: ubuntu-latest
    if: |
      github.event.issue.pull_request == null &&
      startsWith(github.event.issue.title, '[Onboarding]') &&
      contains(github.event.comment.body, '/approve')

    steps:

      - name: First level approval detected (console log)
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          echo "Approval detected for issue #$ISSUE_NUMBER"

      - name: Add first-level-approved label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["first-level-approved"]
            })

      - name: Comment approval message
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "âœ… **First level approval received**\nRunning onboarding actions nowâ€¦"
            })

  onboarding:
    needs: check_approval
    runs-on: ubuntu-latest

    steps:
      - name: Run onboarding process
        id: onboarding
        run: |
          echo "Starting onboarding..."
          sleep 3
          echo "Onboarding complete!"
          date -u +"%Y-%m-%d %H:%M:%S UTC" > timestamp.txt

      - name: Add onboarding-complete label
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ["onboarding-complete"]
            })

      - name: Post completion message
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const timestamp = fs.readFileSync('timestamp.txt', 'utf8');
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ðŸŽ‰ **Onboarding Completed Successfully**\nTimestamp: ${timestamp}`
            })
